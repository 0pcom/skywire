<!-- Content when loading. -->
<div *ngIf="loading || loadingBackendData" class="d-flex flex-column h-100 w-100">
  <div>
    <app-top-bar
      [titleParts]="['vpn.title']"
      [tabsData]="tabsData"
      [selectedTabIndex]="1"
      [showUpdateButton]="false"
      [localVpnKey]="currentLocalPk"
    ></app-top-bar>
  </div>
  <app-loading-indicator class="h-100"></app-loading-indicator>
</div>

<!-- Content when loaded. -->
<div *ngIf="!loading && !loadingBackendData" class="row">
  <div class="col-12">
    <app-top-bar
      [titleParts]="['vpn.title']"
      [tabsData]="tabsData"
      [selectedTabIndex]="1"
      [showUpdateButton]="false"
      [localVpnKey]="currentLocalPk"
    ></app-top-bar>
  </div>
  <div class="col-12">
    <div class="center-container mt-4.5" [ngClass]="{'mb-3': !dataFilterer.currentFiltersTexts || dataFilterer.currentFiltersTexts.length < 1}">
      <!-- Tabs. -->
      <div class="option-bar-container">
        <div class="rounded-elevated-box mt-3"><div class="box-internal-container allow-overflow">
          <div class="option-bar">
            <div class="text-option selected" *ngIf="currentList === lists.Public">{{ 'vpn.server-list.tabs.public' | translate }}</div>
            <a class="text-option" *ngIf="currentList !== lists.Public" [routerLink]="['/vpn', currentLocalPk, 'servers', lists.Public, 1]">
              {{ 'vpn.server-list.tabs.public' | translate }}
            </a>
            <div class="text-option selected" *ngIf="currentList === lists.History">{{ 'vpn.server-list.tabs.history' | translate }}</div>
            <a class="text-option" *ngIf="currentList !== lists.History" [routerLink]="['/vpn', currentLocalPk, 'servers', lists.History, 1]">
              {{ 'vpn.server-list.tabs.history' | translate }}
            </a>
            <div class="text-option selected" *ngIf="currentList === lists.Favorites">{{ 'vpn.server-list.tabs.favorites' | translate }}</div>
            <a class="text-option" *ngIf="currentList !== lists.Favorites" [routerLink]="['/vpn', currentLocalPk, 'servers', lists.Favorites, 1]">
              {{ 'vpn.server-list.tabs.favorites' | translate }}
            </a>
            <div class="text-option selected" *ngIf="currentList === lists.Blocked">{{ 'vpn.server-list.tabs.blocked' | translate }}</div>
            <a class="text-option" *ngIf="currentList !== lists.Blocked" [routerLink]="['/vpn', currentLocalPk, 'servers', lists.Blocked, 1]">
              {{ 'vpn.server-list.tabs.blocked' | translate }}
            </a>
          </div>
        </div></div>
      </div>
      <!-- Filter button. -->
      <div class="option-bar-container option-bar-margin">
        <div class="rounded-elevated-box mt-3"><div class="box-internal-container allow-overflow">
          <div class="option-bar">
            <div class="icon-option" (click)="dataFilterer.changeFilters()" [matTooltip]="'filters.filter-info' | translate">
              <mat-icon [inline]="true">search</mat-icon>
            </div>
          </div>
        </div></div>
      </div>
      <!-- Add button. -->
      <div class="option-bar-container option-bar-margin">
        <div class="rounded-elevated-box mt-3"><div class="box-internal-container allow-overflow">
          <div class="option-bar">
            <div class="icon-option" (click)="enterManually()" [matTooltip]="'vpn.server-list.add-manually-info' | translate">
              <mat-icon [inline]="true">add</mat-icon>
            </div>
          </div>
        </div></div>
      </div>
      <!-- Current filters info. -->
      <br *ngIf="dataFilterer.currentFiltersTexts && dataFilterer.currentFiltersTexts.length > 0" />
      <div class="filter-label subtle-transparent-button cursor-pointer" (click)="dataFilterer.removeFilters()" *ngIf="dataFilterer.currentFiltersTexts && dataFilterer.currentFiltersTexts.length > 0">
        <div class="transparent-50"><mat-icon [inline]="true">search</mat-icon> {{ 'vpn.server-list.current-filters' | translate }}</div>
        <div *ngFor="let filterTexts of dataFilterer.currentFiltersTexts" class="item">
          <span>{{ filterTexts.filterName | translate }}: </span>
          <ng-container *ngIf="filterTexts.translatableValue">{{ filterTexts.translatableValue | translate }}</ng-container>
          <ng-container *ngIf="filterTexts.value">{{ filterTexts.value }}</ng-container>
        </div>
      </div>
    </div>

    <div class="rounded-elevated-box" *ngIf="dataSource.length !== 0"><div class="box-internal-container">
      <!-- Table. -->
      <table
        class="responsive-table-translucid d-none d-md-table"
        *ngIf="dataSource.length > 0"
        cellspacing="0" cellpadding="0"
      >
        <!-- Column names. -->
        <tr>
          <th *ngIf="currentList === lists.History" class="sortable-column date-column" (click)="dataSorter.changeSortingOrder(dateSortData)" [matTooltip]="'vpn.server-list.date-info' | translate">
            <div class="header-container">
              <div class="header-text">
                {{ 'vpn.server-list.date-small-table-label' | translate }}
              </div>
              <mat-icon *ngIf="dataSorter.currentSortingColumn === dateSortData" [inline]="true">{{ dataSorter.sortingArrow }}</mat-icon>
            </div>
          </th>
          <th class="sortable-column flag-column center" (click)="dataSorter.changeSortingOrder(countrySortData)" [matTooltip]="'vpn.server-list.country-info' | translate">
            <mat-icon [inline]="true">flag</mat-icon>
            <mat-icon *ngIf="dataSorter.currentSortingColumn === countrySortData" [inline]="true">{{ dataSorter.sortingArrow }}</mat-icon>
          </th>
          <th class="sortable-column name-column" (click)="dataSorter.changeSortingOrder(nameSortData)">
            <div class="header-container">
              <div class="header-text">
                {{ 'vpn.server-list.name-small-table-label' | translate }}
              </div>
              <mat-icon *ngIf="dataSorter.currentSortingColumn === nameSortData" [inline]="true">{{ dataSorter.sortingArrow }}</mat-icon>
            </div>
          </th>
          <th class="sortable-column location-column" (click)="dataSorter.changeSortingOrder(locationSortData)">
            <div class="header-container">
              <div class="header-text">
                {{ 'vpn.server-list.location-small-table-label' | translate }}
              </div>
              <mat-icon *ngIf="dataSorter.currentSortingColumn === locationSortData" [inline]="true">{{ dataSorter.sortingArrow }}</mat-icon>
            </div>
          </th>
          <th class="sortable-column pk-column" [ngClass]="{'public-pk-column': currentList === lists.Public, 'history-pk-column': currentList === lists.History}" (click)="dataSorter.changeSortingOrder(pkSortData)" [matTooltip]="'vpn.server-list.public-key-info' | translate">
            <div class="header-container">
              <div class="header-text">
                {{ 'vpn.server-list.public-key-small-table-label' | translate }}
              </div>
              <mat-icon *ngIf="dataSorter.currentSortingColumn === pkSortData" [inline]="true">{{ dataSorter.sortingArrow }}</mat-icon>
            </div>
          </th>
          <th *ngIf="currentList === lists.Public" class="sortable-column short-column center" (click)="dataSorter.changeSortingOrder(congestionSortData)" [matTooltip]="'vpn.server-list.congestion-info' | translate">
            <div class="header-container">
              <div class="header-text">
                {{ 'vpn.server-list.congestion-small-table-label' | translate }}
              </div>
              <mat-icon *ngIf="dataSorter.currentSortingColumn === congestionSortData" [inline]="true">{{ dataSorter.sortingArrow }}</mat-icon>
            </div>
          </th>
          <th *ngIf="currentList === lists.Public" class="sortable-column mini-column center" (click)="dataSorter.changeSortingOrder(congestionRatingSortData)" [matTooltip]="'vpn.server-list.congestion-rating-info' | translate">
            <div class="header-container">
              <div class="header-text">
                {{ 'vpn.server-list.congestion-rating-small-table-label' | translate }}
              </div>
              <mat-icon *ngIf="dataSorter.currentSortingColumn === congestionRatingSortData" [inline]="true">{{ dataSorter.sortingArrow }}</mat-icon>
            </div>
          </th>
          <th *ngIf="currentList === lists.Public" class="sortable-column short-column center" (click)="dataSorter.changeSortingOrder(latencySortData)" [matTooltip]="'vpn.server-list.latency-info' | translate">
            <div class="header-container">
              <div class="header-text">
                {{ 'vpn.server-list.latency-small-table-label' | translate }}
              </div>
              <mat-icon *ngIf="dataSorter.currentSortingColumn === latencySortData" [inline]="true">{{ dataSorter.sortingArrow }}</mat-icon>
            </div>
          </th>
          <th *ngIf="currentList === lists.Public" class="sortable-column mini-column center" (click)="dataSorter.changeSortingOrder(latencyRatingSortData)" [matTooltip]="'vpn.server-list.latency-rating-info' | translate">
            <div class="header-container">
              <div class="header-text">
                {{ 'vpn.server-list.latency-rating-small-table-label' | translate }}
              </div>
              <mat-icon *ngIf="dataSorter.currentSortingColumn === latencyRatingSortData" [inline]="true">{{ dataSorter.sortingArrow }}</mat-icon>
            </div>
          </th>
          <th *ngIf="currentList === lists.Public" class="sortable-column mini-column center" (click)="dataSorter.changeSortingOrder(hopsSortData)" [matTooltip]="'vpn.server-list.hops-info' | translate">
            <div class="header-container">
              <div class="header-text">
                {{ 'vpn.server-list.hops-small-table-label' | translate }}
              </div>
              <mat-icon *ngIf="dataSorter.currentSortingColumn === hopsSortData" [inline]="true">{{ dataSorter.sortingArrow }}</mat-icon>
            </div>
          </th>
          <th class="sortable-column note-column center" (click)="dataSorter.changeSortingOrder(noteSortData)" [matTooltip]="'vpn.server-list.note-info' | translate">
            <div class="header-container">
              <div class="header-text">
                {{ 'vpn.server-list.note-small-table-label' | translate }}
              </div>
              <mat-icon *ngIf="dataSorter.currentSortingColumn === noteSortData" [inline]="true">{{ dataSorter.sortingArrow }}</mat-icon>
            </div>
          </th>
          <th class="actions"></th>
        </tr>

        <!-- Values. -->
        <tr *ngFor="let server of dataSource" class="selectable" (click)="selectServer(server)">
          <td  *ngIf="currentList === lists.History" class="date-column">
            {{ server.lastUsed | date:'yyyy/MM/dd, H:mm a' }}
          </td>
          <td class="flag-column icon-fixer">
            <div class="flag">
              <div
                [style]="'background-image: url(\'assets/img/big-flags/' + server.countryCode.toLocaleLowerCase() + '.png\');'"
                [matTooltip]="getCountryName(server.countryCode)"
              ></div>
            </div>
          </td>
          <td class="name-column">
            <mat-icon
              *ngIf="server.pk === currentServer.pk"
              class="known-icon"
              [inline]="true"
              [matTooltip]="'vpn.server-list.selected-info' | translate"
            >done</mat-icon>
            <mat-icon
              *ngIf="server.flag === serverFlags.Favorite && currentList !== lists.Favorites"
              class="known-icon yellow-clear-text"
              [inline]="true"
              [matTooltip]="'vpn.server-list.favorite-info' | translate"
            >star</mat-icon>
            <mat-icon
              *ngIf="server.inHistory && currentList !== lists.History"
              class="known-icon"
              [inline]="true"
              [matTooltip]="'vpn.server-list.history-info' | translate"
            >history</mat-icon>
            <ng-container *ngIf="server.name">
              {{ server.name }}
            </ng-container>
            <ng-container *ngIf="currentList === lists.Public && !server.name">
              {{ 'vpn.server-list.none' | translate }}
            </ng-container>
            <ng-container *ngIf="currentList !== lists.Public && !server.name">
              {{ 'vpn.server-list.none-entered-manually' | translate }}
            </ng-container>
          </td>
          <td class="location-column">
            <ng-container *ngIf="server.location">
              {{ server.location }}
            </ng-container>
            <ng-container *ngIf="currentList === lists.Public && !server.location">
              {{ 'vpn.server-list.unknown' | translate }}
            </ng-container>
            <ng-container *ngIf="currentList !== lists.Public && !server.location">
              {{ 'vpn.server-list.unknown-entered-manually' | translate }}
            </ng-container>
          </td>
          <td class="pk-column" [ngClass]="{'public-pk-column': currentList === lists.Public, 'history-pk-column': currentList === lists.History}">
            <app-copy-to-clipboard-text (click)="$event.stopPropagation()" class="d-inline-block w-100" [shortSimple]="true" [text]="server.pk"></app-copy-to-clipboard-text>
          </td>
          <td  *ngIf="currentList === lists.Public" [class]="getCongestionTextColorClass(server.congestion) + ' center short-column'">
            {{ server.congestion }}%
          </td>
          <td  *ngIf="currentList === lists.Public" class="center mini-column icon-fixer">
            <div
              [style]="'background-image: url(\'assets/img/' + getRatingIcon(server.congestionRating) + '.png\');'"
              class="rating"
              [matTooltip]="getRatingText(server.congestionRating) | translate"
            ></div>
          </td>
          <td  *ngIf="currentList === lists.Public" [class]="getLatencyTextColorClass(server.latency) + ' center short-column'">
            {{ ('common.' + getLatencyValueString(server.latency)) | translate:{ time: getPrintableLatency(server.latency) } }}
          </td>
          <td  *ngIf="currentList === lists.Public" class="center mini-column icon-fixer">
            <div
              [style]="'background-image: url(\'assets/img/' + getRatingIcon(server.latencyRating) + '.png\');'"
              class="rating"
              [matTooltip]="getRatingText(server.latencyRating) | translate"
            ></div>
          </td>
          <td  *ngIf="currentList === lists.Public" [class]="getHopsTextColorClass(server.hops) + ' center mini-column'">
            {{ server.hops }}
          </td>
          <td class="center note-column">
            <mat-icon *ngIf="server.note" (click)="$event.stopPropagation()" [inline]="true" [matTooltip]="server.note" class="note-icon">info_outline</mat-icon>
          </td>
          <td class="actions">
            <button
              mat-icon-button
              class="big-action-button transparent-button"
              [matTooltip]="'vpn.server-list.options-info' | translate"
              (click)="$event.stopPropagation(); openOptions(server);"
            >
              <mat-icon [inline]="true">settings</mat-icon>
            </button>
          </td>
        </tr>
      </table>
    </div></div>

    <!-- Lower paginator. -->
    <app-paginator
      *ngIf="numberOfPages > 1"
      [currentPage]="currentPage"
      [numberOfPages]="numberOfPages"
      [linkParts]="['/vpn']"
      [queryParams]="dataFilterer.currentUrlQueryParams">
    </app-paginator>

    <!-- Msg shown if the list is empty. -->
    <div class="rounded-elevated-box" *ngIf="dataSource.length === 0">
      <div class="box-internal-container font-sm">
        <mat-icon [inline]="true" class="alert-icon">warning</mat-icon>
        <span class="font-sm" *ngIf="allServers.length === 0 && currentList === lists.Public">{{ 'vpn.server-list.empty-discovery' | translate }}</span>
        <span class="font-sm" *ngIf="allServers.length === 0 && currentList === lists.History">{{ 'vpn.server-list.empty-history' | translate }}</span>
        <span class="font-sm" *ngIf="allServers.length === 0 && currentList === lists.Favorites">{{ 'vpn.server-list.empty-favorites' | translate }}</span>
        <span class="font-sm" *ngIf="allServers.length === 0 && currentList === lists.Blocked">{{ 'vpn.server-list.empty-blocked' | translate }}</span>
        <span class="font-sm" *ngIf="allServers.length !== 0">{{ 'vpn.server-list.empty-with-filter' | translate }}</span>
      </div>
    </div>
  </div>
</div>
